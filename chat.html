<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    body {
        padding: 0;
        margin: 0;
    }

    .top {
        width: 100%;
        height: 50px;
        background-color: #eee;
        text-align: center;
        line-height: 50px;
        margin-left: 200px;
    }

    input,
    button {
        outline: none;
    }

    .input {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        height: 100px;
        margin-left: 200px;
    }

    #btn {
        width: 80%;
        height: 100px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    #send {
        height: 100px;
        width: 10%;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .chat {
        text-align: center;
        margin: 20px auto;
    }

    .on {
        display: block;
    }

    .off {
        display: none;
    }

    .chat {
        margin-top: 50px;
    }

    .chat li {
        list-style: none;
        height: 50px;
        width: 150px;
        line-height: 50px;
        background-color: #eee;
    }

    .page {
        overflow: hidden;
    }

    .left {
        position: fixed;
        left: 0;
        top: 0;
        width: 200px;
        height: 100vh;
        background-color: rgba(121, 119, 119, 0.63);
    }

    .right {
        /* width: 100%; */
        margin-left: 200px;
    }

    .message {
        display: flex;
        align-items: center;
        /* flex-direction: column; */
    }

    .img {
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        border-radius: 50%;
        background-color: aqua;
    }
</style>

<body>
    <div class="page_login">
        <input type="text" placeholder="请输入用户名" class="name" />
        <button type="submit" id="login">login</button>
    </div>
    <div class="page off">
        <div class="top">
            聊天室
        </div>
        <div class="div">
            <div class="left">
                <ul class="chat">
                </ul>
            </div>
            <div class="right">

            </div>
        </div>
        <div class="input">
            <input type="text" id="btn">
            <button type="submit" id="send" style="background-color: #eee;">发送</button>
        </div>
    </div>
</body>
<script>
    let topper = document.getElementsByClassName('top')[0]
    let page = document.getElementsByClassName('page')[0]
    let name = document.getElementsByClassName('name')[0]
    let page_login = document.getElementsByClassName('page_login')[0]
    let login = document.getElementById('login')
    let send = document.getElementById('send')
    let btn = document.getElementById('btn')

    let chat = document.getElementsByClassName('chat')[0]
    let right = document.getElementsByClassName('right')[0]
    let lis = document.getElementsByTagName('li')
    // 获取登录用户nickname
    let user = sessionStorage.getItem('user')
    // ws初始赋予null值
    var ws = null
    // 存储除自己外所有用户
    let alluser = []
    // 定义目前聊天为群聊
    let now_object = "群聊"
    // 判断用户是否登录
    if (!user) {
        page.classList.add('off')
    } else {
        page.classList.remove('off')
        page_login.classList.add('off')
    }
    // 登陆事件
    login.onclick = function () {
        if (!name.value) {
            alert('用户名不能为空')
            return
        }
        // 存储用户nickname
        sessionStorage.setItem('user', name.value)
        page.classList.remove('off')
        page_login.classList.add('off')
        // 取出存储的用户nickname
        user = sessionStorage.getItem('user')
        topper.innerHTML = `${user} 聊天室`
        // 创建websocket连接
        ws = new WebSocket("ws://localhost:8080?" + `${user}`)
        // 打开连接
        // 用户首次登陆发送的请求
        ws.onopen = function (e) {
            console.log("连接服务器成功");
            ws.send(JSON.stringify({
                num: 1,
                nickname: user,
                msg: `欢迎${user}`,
                object: "群聊"
            }))
        }
        let str = ""
        // 响应服务端发送过来的数据
        ws.onmessage = function (obj) {
            console.log(JSON.parse(obj.data));
            // 获取当前所有用户并渲染
            if (JSON.parse(obj.data).type === "user") {
                // 从服务端返回所有的用户
                alluser = JSON.parse(obj.data).nickname
                // 对所有用户进行降重处理
                Array.from(new Set(alluser))
                // 去除当前用户自己
                alluser.splice(alluser.indexOf(user), 1)
               
                // 渲染用户列表
                alluser.forEach((item) => {
                    str += `<li>${item}</li>`

                })
                chat.innerHTML = '<li>群聊</li>' + str
                 // 循环用户列表
            Array.from(lis).forEach((item) => {
                right.innerHTML += `<div class="content" index="${item.innerHTML}"></div>`
            });
            }
            let content = document.getElementsByClassName('content')
            // 循环用户列表
            Array.from(lis).forEach((item) => {
                item.onclick = function () {
                    now_object = item.innerHTML
                    Array.from(content).forEach(msg => {
                        msg.classList.add('off')
                        if(item.innerHTML ===msg.getAttribute('index')){
                            msg.classList.remove('off')
                        }
                    })
                    
                }
            });
            Array.from(content).forEach(item => {
                // 第一次进入登陆欢迎
                item.classList.add('off')
                if (item.getAttribute('index') == JSON.parse(obj.data).object||item.getAttribute('index')==JSON.parse(obj.data).nickname) {
                    console.log(item.getAttribute('index'));
                    console.log(JSON.parse(obj.data).object);
                    item.classList.remove('off')
                    if (JSON.parse(obj.data).num === 1) {
                        item.innerHTML += `<p class="message">${JSON.parse(obj.data).msg}</p>`
                    }
                    // 后续发送消息进行渲染
                    if (JSON.parse(obj.data).num === 2 ) {
                        item.innerHTML += `<p class="message"><span class="img">${JSON.parse(obj.data).nickname}</span>${JSON.parse(obj.data).msg}</p>`

                    }
                }
            });


        }
    }
    topper.innerHTML = `${user} 聊天室`

    // 消息发送
    send.onclick = (() => {
        ws.send(JSON.stringify({
            num: 2,
            msg: btn.value,
            nickname: user,
            object: now_object
        }
        ))
        //清空输入框
        btn.value = ""
    })
</script>

</html>